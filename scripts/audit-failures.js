#!/usr/bin/env node
/**
 * GuardSpine Failure Log Auditor
 * Generates weekly markdown reports from guardspine-logs/*.jsonl
 *
 * Usage: node audit-failures.js [--days=7]
 * Output: ~/.openclaw/reports/failure-report-YYYY-MM-DD.md
 */

const fs = require("fs");
const path = require("path");
const readline = require("readline");

const LOG_DIR = path.join(process.env.USERPROFILE || process.env.HOME, ".openclaw", "guardspine-logs");
const REPORT_DIR = path.join(process.env.USERPROFILE || process.env.HOME, ".openclaw", "reports");

// Parse command line args
const args = process.argv.slice(2);
const daysArg = args.find(a => a.startsWith("--days="));
const DAYS = daysArg ? parseInt(daysArg.split("=")[1]) : 7;

async function main() {
  // Ensure report directory exists
  if (!fs.existsSync(REPORT_DIR)) {
    fs.mkdirSync(REPORT_DIR, { recursive: true });
  }

  // Find log files from last N days
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - DAYS);

  const logFiles = [];
  if (fs.existsSync(LOG_DIR)) {
    for (const file of fs.readdirSync(LOG_DIR)) {
      if (file.startsWith("guardspine-") && file.endsWith(".jsonl")) {
        const dateStr = file.replace("guardspine-", "").replace(".jsonl", "");
        const fileDate = new Date(dateStr);
        if (fileDate >= cutoff) {
          logFiles.push(path.join(LOG_DIR, file));
        }
      }
    }
  }

  if (logFiles.length === 0) {
    console.log("No log files found in the last " + DAYS + " days");
    return;
  }

  console.log(`Analyzing ${logFiles.length} log files...`);

  // Parse all entries
  const entries = [];
  for (const logFile of logFiles) {
    const rl = readline.createInterface({
      input: fs.createReadStream(logFile),
      crlfDelay: Infinity
    });

    for await (const line of rl) {
      if (!line.trim()) continue;
      try {
        const entry = JSON.parse(line);
        entries.push(entry);
      } catch (e) {
        // Skip malformed lines
      }
    }
  }

  console.log(`Parsed ${entries.length} total entries`);

  // Filter for failures
  const failures = entries.filter(e =>
    e.action === "COUNCIL_FAIL" ||
    e.action === "COUNCIL_ERROR" ||
    e.action === "L3.5_OPUS_FAIL" ||
    e.action === "BLOCKED" ||
    (e.outcome && e.outcome.includes("DENIED"))
  );

  // Group by tool
  const byTool = {};
  for (const f of failures) {
    const tool = f.tool || f.tool_name || "unknown";
    if (!byTool[tool]) byTool[tool] = [];
    byTool[tool].push(f);
  }

  // Group by error pattern (first 50 chars of reason)
  const byPattern = {};
  for (const f of failures) {
    const reason = (f.reason || f.error || "unknown").substring(0, 50);
    if (!byPattern[reason]) byPattern[reason] = { count: 0, examples: [] };
    byPattern[reason].count++;
    if (byPattern[reason].examples.length < 3) {
      byPattern[reason].examples.push(f);
    }
  }

  // Generate report
  const now = new Date();
  const reportDate = now.toISOString().split("T")[0];
  const startDate = cutoff.toISOString().split("T")[0];

  let report = `# GuardSpine Failure Report
**Period:** ${startDate} to ${reportDate}
**Generated:** ${now.toISOString()}

## Summary

| Metric | Value |
|--------|-------|
| Total entries analyzed | ${entries.length} |
| Total failures | ${failures.length} |
| Failure rate | ${entries.length > 0 ? ((failures.length / entries.length) * 100).toFixed(1) : 0}% |

## Failures by Tool

| Tool | Count |
|------|-------|
`;

  const sortedTools = Object.entries(byTool).sort((a, b) => b[1].length - a[1].length);
  for (const [tool, list] of sortedTools) {
    report += `| ${tool} | ${list.length} |\n`;
  }

  report += `
## Failure Patterns

| Pattern | Count | Example |
|---------|-------|---------|
`;

  const sortedPatterns = Object.entries(byPattern).sort((a, b) => b[1].count - a[1].count);
  for (const [pattern, data] of sortedPatterns.slice(0, 10)) {
    const example = data.examples[0];
    const exampleTool = example?.tool || example?.tool_name || "?";
    report += `| ${pattern.replace(/\|/g, "\\|")} | ${data.count} | ${exampleTool} |\n`;
  }

  report += `
## Recommendations

`;

  // Generate recommendations
  if (sortedTools.length > 0) {
    const topTool = sortedTools[0];
    if (topTool[1].length >= 5) {
      report += `- **High frequency:** \`${topTool[0]}\` has ${topTool[1].length} failures. Consider adding to allowlist if safe.\n`;
    }
  }

  if (failures.length === 0) {
    report += `- No failures this period. System operating normally.\n`;
  }

  report += `
---
*Report generated by audit-failures.js*
`;

  // Write report
  const reportFile = path.join(REPORT_DIR, `failure-report-${reportDate}.md`);
  fs.writeFileSync(reportFile, report, "utf-8");
  console.log(`Report written to: ${reportFile}`);
}

main().catch(console.error);
